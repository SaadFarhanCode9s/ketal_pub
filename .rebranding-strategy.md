# Ketal Rebranding Strategy (ElementX → ketal)

## Overview
This document outlines the rebranding from **ElementX** to **ketal** and provides a strategy for safely managing upstream merges from the Element X iOS repository.

## Changed Files & Configuration

### 1. **Configuration Files (SAFE TO MODIFY)**
These files control the app's identity and can be freely modified without affecting upstream compatibility:

- `project.yml` - Project name and organization settings
- `app.yml` - App display name, bundle identifier, and app group settings
- `localazy.json` - Localization file paths
- `fastlane/Fastfile` - Build automation target references
- `.githooks/pre-commit` - Git hooks (path references)

**Key Changes:**
```yaml
# project.yml
name: ElementX → name: ketal

# app.yml
APP_DISPLAY_NAME: "Element X" → "ketal"
BASE_BUNDLE_IDENTIFIER: "io.element.elementx" → "io.ketal.app"
APP_GROUP_IDENTIFIER: "group.io.element" → "group.io.ketal"
```

### 2. **Directory Rename (CRITICAL)**
- `ElementX/` → `ketal/` (main app source directory)

All references in the following files have been updated:
- `NSE/SupportingFiles/target.yml`
- `UITests/SupportingFiles/target.yml`
- `UITests/SupportingFiles/UITests.xctestplan`
- `UnitTests/SupportingFiles/UnitTests.xctestplan`
- `AccessibilityTests/SupportingFiles/AccessibilityTests.xctestplan`
- `AccessibilityTests/SupportingFiles/target.yml`
- `PreviewTests/SupportingFiles/target.yml`
- All test files (`@testable import ElementX` → `@testable import ketal`)

### 3. **Target Configuration Files (MODIFIED)**
Modified to use new target name and paths:
- `ketal/SupportingFiles/target.yml` - Main app target configuration
- `ketal/SupportingFiles/Info.plist` - Bundle identifier references (auto-generated via xcodegen)
- `ketal/SupportingFiles/ketal.entitlements` (renamed from ElementX.entitlements)

### 4. **Swift Source Code (NOT MODIFIED)**
The following remain unchanged to avoid breaking upstream merges:
- All Swift source files in `ketal/Sources/`
- Service implementations
- UI components
- All Matrix protocol references (these are legitimate protocol/SDK references)

## Upstream Merge Strategy

### When Pulling from Upstream
The upstream repository uses `ElementX` as the directory and project name. When merging upstream changes:

1. **Merge Process:**
   ```bash
   git fetch upstream
   git merge upstream/main
   ```

2. **Expected Conflicts:**
   - `project.yml` - Will conflict on name and pattern settings
   - `app.yml` - Will conflict on bundle ID and app name settings
   - All `target.yml` files - Will conflict on target references
   - Test files - Will conflict on `@testable import` statements

3. **Resolution Strategy:**
   - Keep **ketal** version of configuration files
   - Accept upstream source code changes
   - Re-run `xcodegen` after merge: `swift run tools setup-project`

### Safe Merge Steps:
```bash
# 1. Fetch upstream
git fetch upstream

# 2. Create merge branch
git checkout -b merge/upstream-main

# 3. Attempt merge (will have conflicts)
git merge upstream/main

# 4. Resolve conflicts - prefer ketal branding files
# Edit conflicted files, keeping ketal names/identifiers

# 5. Regenerate project
swift run tools setup-project

# 6. Test build
xcodebuild -scheme ketal -configuration Debug

# 7. Commit merge
git add .
git commit -m "Merge upstream/main - keep ketal branding"
```

## Files to Track for Conflicts

### High Priority (Always resolve to ketal version):
- `project.yml` - Line: `name: ketal`
- `app.yml` - Lines: `APP_DISPLAY_NAME`, `BASE_BUNDLE_IDENTIFIER`, `APP_GROUP_IDENTIFIER`
- `ketal/SupportingFiles/target.yml` - Target name references

### Medium Priority (Update paths from ElementX to ketal):
- `NSE/SupportingFiles/target.yml` - Source paths
- `UITests/SupportingFiles/target.yml` - Source paths
- `*.xctestplan` files - Container paths
- `.githooks/pre-commit` - Project path references
- `localazy.json` - Output paths
- `fastlane/Fastfile` - Target and project path references

### Low Priority (Usually non-conflicting):
- Source code files (already updated imports)
- Test files (already updated imports)

## Bundle ID & App Name Mappings

| Item | Original | Ketal |
|------|----------|-------|
| App Display Name | Element X | ketal |
| Bundle ID | io.element.elementx | io.ketal.app |
| App Group | group.io.element | group.io.ketal |
| Keychain Group | io.element.elementx | io.ketal.app |
| Target Name | ElementX | ketal |
| Directory Name | ElementX/ | ketal/ |
| Project File | ElementX.xcodeproj | ketal.xcodeproj (auto-generated) |

## Entitlements Changes

The app entitlements have been updated to reflect the new bundle ID:
- File renamed: `ElementX.entitlements` → `ketal.entitlements`
- Associated domains remain: `element.io`, `app.element.io`, `matrix.to` (these are service-level, not app-level)
- App groups updated to use new identifier: `group.io.ketal`

## Build & Archive Notes

When building or archiving:
- Use scheme: **ketal** (not ElementX)
- Bundle identifier: **io.ketal.app**
- App name: **ketal**
- Signing team: Configured in `app.yml` (DEVELOPMENT_TEAM)

## CI/CD Pipeline Considerations

If using Fastlane or CI/CD:
- Update script references from `ElementX.xcodeproj` → `ketal.xcodeproj` (auto-generated after xcodegen)
- Update scheme references from `Element X` → `ketal`
- Update target references in test commands

## Rebuilding from Scratch

If you need to regenerate the Xcode project:
```bash
swift run tools setup-project
# This runs xcodegen and regenerates ElementX.xcodeproj → ketal.xcodeproj
```

## Git Configuration for Future Merges

To make future upstream merges easier, consider using git attributes:

```bash
# Add to .gitattributes
app.yml merge=ours
project.yml merge=ours
ketal/SupportingFiles/target.yml merge=ours
```

This will keep your local version when merging, then you can manually integrate upstream changes to source files.

## Troubleshooting

### "ElementX has no scheme" error
- Run `swift run tools setup-project` to regenerate with new names

### Import errors in tests
- Verify all test files have `@testable import ketal` (not ElementX)
- Check that `ketal/SupportingFiles/target.yml` is correctly configured

### Bundle ID mismatches
- Check `app.yml` for BASE_BUNDLE_IDENTIFIER
- Verify `ketal/SupportingFiles/target.yml` references the correct variable

### Entitlements errors
- Verify `ketal.entitlements` file exists (renamed from ElementX.entitlements)
- Check `ketal/SupportingFiles/target.yml` points to `ketal.entitlements`

## References

- **XcodeGen Config**: `project.yml`, `app.yml`, `ketal/SupportingFiles/target.yml`
- **Main Settings**: `ketal/Sources/Application/AppSettings.swift`
- **Build Config**: `.github/workflows/` (if using GitHub Actions)
- **Fastlane Config**: `fastlane/Fastfile`
